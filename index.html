<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>seest - Self Estimate Timer</title>
    </head>
    <body>
        <p>
            Info + Instructions
        </p>
        <form>
            <input type="text" id="estimate_input" value="2h30m40s">
            <input type="button" id="start_timer" value="Start" disabled=true>
        </form>
        <p>
            Estimate: <span id="estimate_display">##:##:##</span>
            <br>
            Current: <span id="timer">##:##:##</span>
            <br>
            <input type="button" id="finish_timer" value="Finish" disabled=true>
        </p>

        <p id="results">
            Accuracy: <span id="accuracy"></span>%, off by <span id="offset"></span>
            <br>
            Started: <span id="start_time"></span> 
            <br>
            Ended: <span id="end_time"></span>
        </p>

        <script>
            // Truncated Date ms (not displayed to users) so timer
            // isn't off by 1 second compared to start/end times.

            // Set button states to override any cached states
            window.onload = function() {
                var start_bt = document.getElementById("start_timer");
                start_bt.onclick = process_estimate;
                start_bt.disabled = false;
                reset_display();
                document.getElementById("finish_timer").disabled = true;
            };

            function reset_display() {
                document.getElementById("estimate_display").innerHTML = "";
                document.getElementById("timer").innerHTML = "";
                document.getElementById("accuracy").innerHTML = "##";
                document.getElementById("offset").innerHTML = "##:##:##";
                document.getElementById("start_time").innerHTML = "";
                document.getElementById("end_time").innerHTML = "";
            }

            function duration(hour, min, sec, ms) {
                var dur = new Date(0);
                dur.setHours( dur.getHours() + ((hour) ? hour : 0) );
                dur.setMinutes( dur.getMinutes() + ((min) ? min : 0) );
                dur.setSeconds( dur.getSeconds() + ((sec) ? sec : 0) );
                dur.setMilliseconds( dur.getMilliseconds() + ((ms) ? ms : 0) );
                return dur;
            }

            Date.prototype.toDuration = function() {
                var ms = Math.abs(this.getTime());
                var hour = Math.floor( ms / (1000 * 60 * 60) );
                var min = Math.floor( ms / (1000 * 60) ) % 60;
                var sec = Math.floor( ms / 1000 ) % 60;
                var prefix = (this.getTime() < 0) ? "-" : "";
                function pad(i) { return ((i < 10) ? "0" : "") + i; }
                return prefix.concat( pad(hour), ":", pad(min), ":", pad(sec) );
            }

            Date.prototype.add = function(date2) {
                this.setMilliseconds( this.getMilliseconds() + date2.getTime() );
            }
            Date.prototype.subtract = function(date2) {
                this.setMilliseconds( this.getMilliseconds() - date2.getTime() );
            }

            function process_estimate() {
                var display_text = "invalid input";
                var estimate = parse_duration(document.getElementById("estimate_input").value);
                var timer = document.getElementById("timer");
                var curr_time = new Date();
                curr_time.setMilliseconds(0);
                var finish_bt = document.getElementById("finish_timer");
                var updater = function(){ update_timer(timer, curr_time); }
                var updaterID;
                reset_display();
                if( estimate != null ){
                    document.getElementById("start_timer").disabled = true;
                    document.getElementById("start_time").innerHTML = curr_time.toLocaleString();
                    display_text = estimate.toDuration();
                    updater();
                    updaterID = setInterval(updater, 250);
                    finish_bt.onclick = function() { finish_timer( updaterID, curr_time, estimate) };
                    finish_bt.disabled = false;
                }
                document.getElementById("estimate_display").innerHTML = display_text;
            }

            function parse_duration(str) {
                var hour = -1, min = -1, sec = -1;
                var valid_expr = /^(\d+h)?(\d+m)?(\d+s)?$/i;
                function parse_unit(regex) {
                    var unit = parseInt(regex.exec(str), 10);
                    return (isNaN(unit)) ? 0 : unit;
                }

                if( !valid_expr.test(str) ) return null;

                hour = parse_unit( /\d+h/i );
                min = parse_unit( /\d+m/i );
                sec = parse_unit( /\d+s/i );
                return duration(hour, min, sec);
            }

            function update_timer(element, start_time) {
                var elapsed = new Date();
                elapsed.setMilliseconds(0);
                elapsed.subtract(start_time);
                element.innerHTML = elapsed.toDuration();
            }

            function finish_timer(updaterID, start_time, estimated_time) {
                var curr_time;
                document.getElementById("finish_timer").disabled = true;
                curr_time = new Date();
                clearInterval(updaterID);
                curr_time.setMilliseconds(0);
                // Update timer incase there was significant delay in stopping timer
                var elapsed = new Date(curr_time - start_time);
                document.getElementById("timer").innerHTML = elapsed.toDuration();

                var diff = duration(0, 0, 0, Math.abs(elapsed - estimated_time));
                var acc = (estimated_time < elapsed) ? estimated_time / elapsed : elapsed / estimated_time;
                acc = (acc * 100).toFixed(2);

                document.getElementById("accuracy").innerHTML = acc;
                document.getElementById("offset").innerHTML = diff.toDuration();
                document.getElementById("end_time").innerHTML = curr_time.toLocaleString();
                document.getElementById("start_timer").disabled = false;
            }
        </script>
    </body>
</html>

