<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>seest - Self Estimate Timer</title>
    </head>
    <body>
        <p>
            Info + Instructions
        </p>
        <form>
            <input type="text" id="estimate_input" value="2h30m40s">
            <input type="button" id="start_timer" value="Start" onclick="process_estimate()">
        </form>
        <p>
            Estimate: <span id="estimate_display">##:##:##</span>
            <br>
            Current: <span id="timer">##:##:##</span>
            <br>
            <input type="button" id="finish_timer" value="Finish" disabled=true>
        </p>
        <p>Results</p>

        <script>
            function duration(hours, minutes, seconds, milliseconds) {
                this.hour = hours ? hours : 0;
                this.min = minutes ? minutes : 0;
                this.sec = seconds ? seconds : 0;
                this.ms = milliseconds ? milliseconds : 0;

                this.normalize = function() {
                    this.sec += Math.floor(this.ms/1000);
                    this.min += Math.floor(this.sec/60);
                    this.hour += Math.floor(this.min/60);
                    this.ms %= 1000;
                    this.sec %= 60;
                    this.min %= 60;
                }

                this.toString = function() {
                    function pad(int_unit){
                        return ((int_unit < 10 ) ? "0" : "") + int_unit;
                    }
                    return pad(this.hour).concat( ":", pad(this.min), ":", pad(this.sec) );
                }
            }

            function process_estimate() {
                var display_text = "invalid input";
                var estimate = parse_duration(document.getElementById("estimate_input").value);
                var timer = document.getElementById("timer");
                var curr_time = new Date();
                var updater = function(){ update_timer(timer, curr_time); }

                if( estimate != null ){
                    display_text = estimate.toString();
                    updater();
                    setInterval(updater, 250);
                }
                document.getElementById("estimate_display").innerHTML = display_text;
            }

            function parse_duration(str) {
                var hour = -1, min = -1, sec = -1;
                var valid_expr = /^(\d+h)?(\d+m)?(\d+s)?$/i;
                var dur;
                function parse_unit(regex) {
                    var unit = parseInt(regex.exec(str), 10);
                    return (isNaN(unit)) ? 0 : unit;
                }

                if( !valid_expr.test(str) ) return null;

                hour = parse_unit( /\d+h/i );
                min = parse_unit( /\d+m/i );
                sec = parse_unit( /\d+s/i );
                dur = new duration(hour, min, sec);
                dur.normalize();
                return dur;

            }

            function update_timer(element, start_time) {
                var ms = new Date() - start_time;
                var elapsed = new duration(0, 0, 0, ms);
                elapsed.normalize();
                element.innerHTML = elapsed.toString();
            }

        </script>
    </body>
</html>

