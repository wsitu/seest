<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>seest - Self Estimate Timer</title>
    </head>
    <body>
        <p>
            Info + Instructions
        </p>
        <form>
            <input type="text" id="estimate_input" value="2h30m40s">
            <input type="button" id="start_timer" value="Start" onclick="process_estimate()">
        </form>
        <p>
            Estimate: <span id="estimate_display">##:##:##</span>
            <br>
            Current: <span id="timer">##:##:##</span>
            <br>
            <input type="button" id="finish_timer" value="Finish" disabled=true>
        </p>
        <p>Results</p>

        <script>
            function duration(hour, min, sec, ms) {
                var dur = new Date(0);
                dur.setHours( dur.getHours() + ((hour) ? hour : 0) );
                dur.setMinutes( dur.getMinutes() + ((min) ? min : 0) );
                dur.setSeconds( dur.getSeconds() + ((sec) ? sec : 0) );
                dur.setMilliseconds( dur.getMilliseconds() + ((ms) ? ms : 0) );
                return dur;
            }

            Date.prototype.toDuration = function() {
                var ms = Math.abs(this.getTime());
                var hour = Math.floor( ms / (1000 * 60 * 60) );
                var min = Math.floor( ms / (1000 * 60) ) % 60;
                var sec = Math.floor( ms / 1000 ) % 60;
                var prefix = (this.getTime() < 0) ? "-" : "";
                function pad(i) { return ((i < 10) ? "0" : "") + i; }
                return prefix.concat( pad(hour), ":", pad(min), ":", pad(sec) );
            }

            Date.prototype.add = function(date2) {
                this.setMilliseconds( this.getMilliseconds() + date2.getTime() );
            }
            Date.prototype.subtract = function(date2) {
                this.setMilliseconds( this.getMilliseconds() - date2.getTime() );
            }

            function process_estimate() {
                var display_text = "invalid input";
                var estimate = parse_duration(document.getElementById("estimate_input").value);
                var timer = document.getElementById("timer");
                var curr_time = new Date();
                var updater = function(){ update_timer(timer, curr_time); }

                if( estimate != null ){
                    display_text = estimate.toDuration();
                    updater();
                    setInterval(updater, 250);
                }
                document.getElementById("estimate_display").innerHTML = display_text;
            }

            function parse_duration(str) {
                var hour = -1, min = -1, sec = -1;
                var valid_expr = /^(\d+h)?(\d+m)?(\d+s)?$/i;
                function parse_unit(regex) {
                    var unit = parseInt(regex.exec(str), 10);
                    return (isNaN(unit)) ? 0 : unit;
                }

                if( !valid_expr.test(str) ) return null;

                hour = parse_unit( /\d+h/i );
                min = parse_unit( /\d+m/i );
                sec = parse_unit( /\d+s/i );
                return duration(hour, min, sec);
            }

            function update_timer(element, start_time) {
                var elapsed = new Date();
                elapsed.subtract(start_time);
                element.innerHTML = elapsed.toDuration();
            }

        </script>
    </body>
</html>

